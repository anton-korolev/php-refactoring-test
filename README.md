# Пример рефакторинга кода

Требуется провести анализ и рефакторинг [кода](./old/ReturnOperation.php) в соответсвии с [заданием](./old/readme.md).

Дополнительное требование: код окружающей системы должен сохранять работоспособность при минимальных доработках.

## Назначение кода

Отправка уведомлений сотрудникам и клиенту о создании и изменении статуса операции возврата товара:

- Сотрудникам отправляются на email все уведомления по операции;
- Клиенту отправляются на email и по SMS только уведомления об изменении статуса операции.

Класс `ReturnOperation` реализует паттерн **Команда**.

## Основные ошибки и недостатки исходного кода

Недостатки:

- У класса `ReturnOperation` слишком много ответственности (валидация входных данных и отправка уведомлений).
- Неполная валидация входных данных и как следствие - возникновение непредвиденных исключений.
- Зависимость от глобального массива `$_REQUEST`.
- Зависимость от сущностей предметной области.
- Отправка уведомлений сотрудникам с некорректным типом события.

Выявленные ошибки в методе `ReturnOperation::doOperation()`:

- Стр. 13. Неправильный тип возвращаемого значения (должно было быть `array`).
- Стр. 15. Получение исходных данных из непонятного ключа `$_REQUEST['data']`.
- Стр. 16, 17, 41, 51, 56, 66, 67, 72-83, 121, 126. Использование непроверенных данных:
  - Нет проверки на существование ключа массива.
  - Нет проверки корректности значений.
- Стр. 28-29. Некорректный выход при ошибке валидации (должно было быть `throw new \Exception(...)`).
- Стр. 41. Неправильный тип Клиента. Скорее всего, для Клиента должен быть свой класс `Client` наследник от `Contractor`, а не `Contractor` напрямую.
- Стр. 106. Отправка уведомлений сотрудникам с некорректным типом события.

## Что сделано

### Подготовка:

- Доработаны [классы сущностей](./src/Other/Entities) предметной области. 
- Добавлены [заглушки](./src/Other/Stubs/) для эмуляции поведения внешней системы.
- Предполагается, что классы [MessagesClient](./src/Other/Stubs/MessagesClient.php) и [NotificationManager](./src/Other/Stubs/NotificationManager.php) отправляют уведомления не напрямую, а через постановку зданий в очередь.

### Реализация:

- Входные данные для команды [TsReturnOperation](./src/Operations/Notification/TsReturnOperation.php) реализованы в виде отдельного класса [TsReturnOperationParameters](./src/Operations/Notification/TsReturnOperationParameters.php).
- Статус операции [OperationStatus](./src/Other/OperationStatus.php) и тип события [NotificationEvent](./src/Operations/Notification/NotificationEvent.php) реализованы в виде `Enum`.
- Для создания экземппляра параметров `TsReturnOperationParameters` из необработанных входных данных (ассоциативного массива) реализован класс [TsReturnOperationRequest](./src/Operations/Notification/TsReturnOperationRequest.php). Он отвечает за валидацию данных, создание экземпляра `TsReturnOperationParameters` в случае успеха и накопление ошибок валидации.
- Команда `TsReturnOperation` полностью избавлена от всех внешних зависимостей. Все необходимые зависимости (`TsReturnOperationParameters`, `MessagesClient`, `NotificationManager`) подключаются через конструктор.
- Возвращаемое значение метода `TsReturnOperation::doOperation()` реализовано в виде объекта класса `TsReturnOperationResult` и преобразуется в массив при выходе. Когда вызывающий код будет готов принять в качестве ответа соответствующий объект - преобразование в массив можно будет убрать.
- Весь код выполнен со 100% строгой типизацией.

### Описание:

Выделение отдельного класса параметров `TsReturnOperationParameters` позволяет существенно расширить область применения команды `TsReturnOperation`, снизить вероятность возникновения непредвиденных ошибок и упростить код системы. Типизация параметров конструктора класса `TsReturnOperationParameters` и дополнительная проверка логической целостности исходных данных гарантирует валидное состояние всех объектов данного класса.

Характер команды `TsReturnOperation` предполагает ее независимость от внешних источников данных (возможно, кроме настроек системы). По этой причине все необходимые данные передаются в готовом виде через класс параметров `TsReturnOperationParameters`.

Теперь команда `TsReturnOperation` легко может быть сериализована.

Команда `TsReturnOperation` скорее всего вызывается в конце другой, более крупной, операции по обработке процесса возврата товара. Поэтому объект параметров `TsReturnOperationParameters` может быть создан из уже имеющихся валидных данных. 

Кроме этого, при необходимости, объект параметров может быть напрямую создан из необработанных входных данных (ассоциативного массива) с помощью класса `TsReturnOperationRequest`. В случае использования фреймворка эту операцию также можно выполнить с помощью его инструментов: например, Model в Yii или FormRequest в Laravel.
